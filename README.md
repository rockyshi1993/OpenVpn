# OpenVPN 安装脚本

这是一个用于自动安装和配置 OpenVPN 服务器的脚本，该脚本支持多种 Linux 发行版，包括 Debian、Ubuntu、CentOS、Fedora、Oracle Linux、Amazon Linux 和 Arch Linux。

## 功能特点

- 自动检测操作系统类型和版本
- 自动安装 OpenVPN 和所需依赖
- 自动配置 PKI（公钥基础设施）和证书
- 支持 IPv6
- 支持自定义端口和协议（UDP/TCP）
- 多种 DNS 解析器选项
- 可选的数据压缩
- 可自定义加密设置
- 支持 ECDSA 和 RSA 证书
- 支持 ECDH 和 DH 密钥交换
- 自动配置防火墙规则
- 完整的客户端管理功能
  - 添加新用户
  - 撤销现有用户
  - 查看当前用户列表及状态
- 高级服务器管理功能
  - 在不重新安装的情况下更新服务器配置（端口、协议、加密）
  - 实时查看服务器状态和连接的客户端
  - 为客户端设置带宽限制
  - 动态调整DNS设置
- 完整的卸载功能
- 详细的日志记录和错误处理

## 系统要求

- 支持的操作系统：
  - Debian 9+
  - Ubuntu 16.04+
  - CentOS 7+
  - Fedora
  - Oracle Linux 8
  - Amazon Linux 2
  - Amazon Linux 2023.6+
  - Arch Linux
- root 权限
- TUN 模块可用

## 使用方法

### 安装 OpenVPN

1. 下载脚本：

```bash
wget https://raw.githubusercontent.com/rockyshi1993/OpenVpn/master/install.sh -O install.sh
chmod +x install.sh
```

2. 运行脚本：

```bash
./install.sh
```

3. 按照提示进行配置：
   - 选择 IP 地址
   - 是否启用 IPv6
   - 选择端口
   - 选择协议（UDP/TCP）
   - 选择 DNS 解析器
   - 是否启用压缩
   - 是否自定义加密设置

4. 安装完成后，客户端配置文件将保存在执行脚本的目录中。

### 管理 OpenVPN

如果 OpenVPN 已经安装，再次运行脚本将显示管理菜单：

```bash
./install.sh
```

管理菜单提供以下选项：
1. 添加新用户
2. 撤销现有用户
3. 查看当前用户列表
4. 更新OpenVPN配置
5. 检查OpenVPN状态
6. 设置带宽限制
7. 调整DNS设置
8. 卸载 OpenVPN
9. 退出

## 配置选项详解

### IP 地址

脚本会自动检测服务器的公共 IP 地址。如果服务器位于 NAT 后面，您需要提供公共 IP 地址或主机名。

### IPv6 支持

您可以选择是否启用 IPv6 支持。脚本会自动检测服务器是否有 IPv6 连接，并给出建议。

### 端口

您可以选择以下端口选项：
- 默认端口 (1194)
- 自定义端口
- 随机端口 (49152-65535)

### 协议

您可以选择以下协议：
- UDP（推荐，速度更快）
- TCP（仅在 UDP 不可用时使用）

### DNS 解析器

脚本提供多种 DNS 解析器选项：
1. 当前系统解析器（来自 /etc/resolv.conf）
2. 自托管 DNS 解析器 (Unbound)
3. Cloudflare (1.1.1.1, 1.0.0.1)
4. Quad9 (9.9.9.9, 149.112.112.112)
5. Quad9 无审查 (9.9.9.10, 149.112.112.10)
6. FDN (80.67.169.40, 80.67.169.12)
7. DNS.WATCH (84.200.69.80, 84.200.70.40)
8. OpenDNS (208.67.222.222, 208.67.220.220)
9. Google (8.8.8.8, 8.8.4.4)
10. Yandex Basic (77.88.8.8, 77.88.8.1)
11. AdGuard DNS (94.140.14.14, 94.140.15.15)
12. NextDNS (45.90.28.167, 45.90.30.167)
13. 自定义 DNS

### 压缩

您可以选择是否启用压缩。由于 VORACLE 攻击利用压缩，因此不推荐使用。如果启用，可以选择以下压缩算法：
- LZ4-v2（推荐）
- LZ4
- LZO

### 加密设置

您可以使用默认的安全参数，或自定义以下加密设置：

#### 数据通道加密算法
- AES-128-GCM（推荐）
- AES-192-GCM
- AES-256-GCM
- AES-128-CBC
- AES-192-CBC
- AES-256-CBC

#### 证书类型
- ECDSA（推荐）
  - 曲线选项：prime256v1（推荐）、secp384r1、secp521r1
- RSA
  - 密钥大小选项：2048 位（推荐）、3072 位、4096 位

#### 控制通道加密算法
- ECDSA 证书：ECDHE-ECDSA-AES-128-GCM-SHA256（推荐）或 ECDHE-ECDSA-AES-256-GCM-SHA384
- RSA 证书：ECDHE-RSA-AES-128-GCM-SHA256（推荐）或 ECDHE-RSA-AES-256-GCM-SHA384

#### Diffie-Hellman 密钥类型
- ECDH（推荐）
  - 曲线选项：prime256v1（推荐）、secp384r1、secp521r1
- DH
  - 密钥大小选项：2048 位（推荐）、3072 位、4096 位

#### HMAC 摘要算法
- SHA-256（推荐）
- SHA-384
- SHA-512

#### 控制通道额外安全机制
- tls-crypt（推荐）：对数据包进行身份验证和加密
- tls-auth：仅对数据包进行身份验证

## 客户端配置

安装完成后，客户端配置文件（.ovpn）将保存在执行脚本的目录中。您需要将此文件导入到 OpenVPN 客户端中。

### 支持的客户端

- **Windows**: [OpenVPN GUI](https://openvpn.net/community-downloads/)
- **macOS**: [Tunnelblick](https://tunnelblick.net/) 或 [OpenVPN Connect](https://openvpn.net/client-connect-vpn-for-mac-os/)
- **Linux**: 命令行客户端或 NetworkManager
- **Android**: [OpenVPN Connect](https://play.google.com/store/apps/details?id=net.openvpn.openvpn)
- **iOS**: [OpenVPN Connect](https://apps.apple.com/us/app/openvpn-connect/id590379981)

## 添加新客户端

要为新客户端创建配置文件，只需再次运行脚本并选择"添加新用户"选项：

```bash
./install.sh
```

然后输入客户端名称，并选择是否为客户端添加密码保护。

## 撤销客户端证书

要撤销客户端证书，运行脚本并选择"撤销现有用户"选项：

```bash
./install.sh
```

然后选择要撤销的客户端证书。

## 卸载 OpenVPN

要卸载 OpenVPN，运行脚本并选择"卸载 OpenVPN"选项：

```bash
./install.sh
```

这将完全删除 OpenVPN 及其所有配置文件、证书和密钥。

## 高级管理功能

### 查看当前用户列表

此功能允许您查看所有已创建的客户端证书及其状态（有效或已撤销）。

使用此功能，您可以：
- 查看所有客户端证书的列表
- 查看每个证书的状态（有效或已撤销）
- 查看证书的过期日期或撤销日期
- 获取客户端总数统计

这对于管理大量用户或需要审计谁有权访问VPN时非常有用。

### 更新OpenVPN配置

此功能允许您在不重新安装的情况下修改服务器设置。您可以更新以下配置：

1. **端口**：
   - 默认端口 (1194)
   - 自定义端口
   - 随机端口 (49152-65535)

2. **协议**：
   - UDP（推荐，速度更快）
   - TCP（仅在UDP不可用时使用）

3. **加密算法**：
   - AES-128-GCM（推荐）
   - AES-192-GCM
   - AES-256-GCM
   - AES-128-CBC
   - AES-192-CBC
   - AES-256-CBC

更新配置后，脚本会自动重启OpenVPN服务以应用更改。注意，更改这些设置后，您可能需要更新现有客户端的配置文件，或为它们生成新的配置文件。

### 检查OpenVPN状态

此功能提供OpenVPN服务器的实时状态信息，包括：

1. **服务状态**：
   - 显示服务是否正在运行
   - 显示服务运行时间

2. **连接的客户端**：
   - 显示当前连接的所有客户端
   - 显示每个客户端的IP地址
   - 显示每个客户端的流量统计（上传/下载）
   - 显示连接时间

3. **虚拟IP路由表**：
   - 显示分配给客户端的虚拟IP
   - 显示最后更新时间

4. **服务器配置信息**：
   - 显示当前端口、协议和加密设置
   - 显示当前DNS设置

这对于监控服务器状态、排查连接问题或审计用户活动非常有用。

### 设置带宽限制

此功能允许您为客户端设置带宽限制，控制其上传和下载速度。您可以：

1. **选择客户端**：
   - 为特定客户端设置限制
   - 为所有客户端设置相同的限制

2. **限制类型**：
   - 上传和下载限制
   - 仅上传限制
   - 仅下载限制
   - 移除带宽限制

3. **速度限制**：
   - 以KB/s为单位设置速度限制

带宽限制对于防止单个用户占用过多网络资源、确保公平分配带宽或实施不同级别的服务非常有用。

### 调整DNS设置

此功能允许您在不重新安装的情况下更改DNS设置。您可以选择以下DNS提供商：

1. **当前系统解析器** (来自 /etc/resolv.conf)
2. **自托管DNS解析器** (Unbound)
3. **Cloudflare** (1.1.1.1, 1.0.0.1)
4. **Quad9** (9.9.9.9, 149.112.112.112)
5. **Quad9 无审查** (9.9.9.10, 149.112.112.10)
6. **FDN** (80.67.169.40, 80.67.169.12)
7. **DNS.WATCH** (84.200.69.80, 84.200.70.40)
8. **OpenDNS** (208.67.222.222, 208.67.220.220)
9. **Google** (8.8.8.8, 8.8.4.4)
10. **Yandex Basic** (77.88.8.8, 77.88.8.1)
11. **AdGuard DNS** (94.140.14.14, 94.140.15.15)
12. **NextDNS** (45.90.28.167, 45.90.30.167)
13. **自定义DNS**

如果选择自托管DNS解析器(Unbound)但尚未安装，脚本会提供安装选项。

更改DNS设置对于提高隐私保护、实施内容过滤或优化DNS解析速度非常有用。

## 故障排除

### 常见问题

1. **TUN 模块不可用**：确保您的系统支持 TUN/TAP 设备。在某些 VPS 提供商中，您可能需要在控制面板中启用 TUN/TAP。

2. **端口被占用**：如果您选择的端口已被其他服务占用，请选择其他端口。

3. **防火墙问题**：确保您的防火墙允许 OpenVPN 端口。脚本会自动添加必要的防火墙规则，但某些系统可能需要额外配置。

4. **客户端连接问题**：
   - 检查客户端配置文件是否正确
   - 确保服务器端口已开放
   - 检查服务器防火墙设置
   - 验证服务器 IP 地址是否正确

5. **DNS 解析问题**：如果客户端可以连接但无法解析域名，请尝试使用不同的 DNS 解析器选项。

### 日志文件

检查 OpenVPN 日志文件以获取更多信息：

```bash
cat /var/log/openvpn/status.log   # 状态日志
journalctl -u openvpn@server      # 系统日志（systemd）
```

## 安全建议

- 定期更新系统和 OpenVPN
- 使用强密码保护客户端证书
- 定期撤销不再使用的客户端证书
- 考虑使用更强的加密设置（如 AES-256-GCM）
- 避免使用压缩（由于 VORACLE 攻击）
- 使用 tls-crypt 而不是 tls-auth 以提供更好的安全性

## 优化历史

### 2023-11-20 优化更新

1. **日志系统**
   - 添加了详细的日志记录功能，所有操作都会记录到 `/var/log/openvpn-install.log`
   - 添加了时间戳和颜色标记，使日志更易读

2. **错误处理**
   - 添加了统一的错误处理机制 `error_exit` 函数
   - 添加了 `run_cmd` 函数，用于执行命令并记录结果
   - 添加了信号处理和清理机制，确保脚本中断时能清理临时文件

3. **配置文件管理**
   - 客户端配置文件现在默认保存在执行脚本的目录中
   - 添加了配置文件备份功能 `backup_config`，在修改配置前自动备份
   - 添加了安全权限设置功能 `secure_permissions`

4. **用户体验改进**
   - 添加了进度显示功能 `show_progress`
   - 优化了提示信息，使其更清晰
   - 所有提示和日志信息均使用中文

5. **代码结构优化**
   - 重构了大型函数，提高了代码可读性和可维护性
   - 添加了更多注释，解释代码功能
   - 统一了代码风格和命名规范

## 致谢

此脚本基于 [angristan/openvpn-install](https://github.com/angristan/openvpn-install) 项目。
